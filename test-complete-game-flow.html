<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Game Flow Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .test-section {
        background: #2a2a2a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid #444;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .info {
        color: #2196f3;
      }
      .warning {
        color: #ff9800;
      }
      pre {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .game-card {
        background: #333;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #555;
      }
      .step {
        background: #444;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ® Complete Game Flow Test</h1>

    <div class="test-section">
      <h2>Game Flow Verification</h2>
      <div id="results"></div>
      <button onclick="testCompleteFlow()">ğŸš€ Test Complete Game Flow</button>
      <button onclick="simulateGameLaunch()">ğŸ® Simulate Game Launch</button>
    </div>

    <script>
      async function testCompleteFlow() {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML =
          '<div class="info">ğŸ” Testing complete game flow...</div>';

        try {
          // Step 1: Load games from API
          resultsDiv.innerHTML +=
            '<div class="step">ğŸ“¡ Step 1: Loading games from API...</div>';

          const response = await fetch("/api/games");
          const data = await response.json();

          if (!data.success || !data.data || data.data.length === 0) {
            throw new Error("No games available");
          }

          resultsDiv.innerHTML += `<div class="success">âœ… Loaded ${data.data.length} games</div>`;

          // Step 2: Select a test game
          const testGame =
            data.data.find(
              (g) => g.instructions && g.instructions.length > 0
            ) || data.data[0];
          resultsDiv.innerHTML += `<div class="step">ğŸ® Step 2: Selected game: ${testGame.title}</div>`;

          // Step 3: Verify game has all required data
          const requiredFields = [
            "title",
            "description",
            "instructions",
            "difficulty",
            "time_limit",
            "max_score",
            "xp_reward",
          ];
          const missingFields = requiredFields.filter(
            (field) => !testGame[field]
          );

          if (missingFields.length > 0) {
            resultsDiv.innerHTML += `<div class="warning">âš ï¸ Missing fields: ${missingFields.join(
              ", "
            )}</div>`;
          } else {
            resultsDiv.innerHTML +=
              '<div class="success">âœ… Game has all required data</div>';
          }

          // Step 4: Test sessionStorage
          resultsDiv.innerHTML +=
            '<div class="step">ğŸ’¾ Step 4: Testing sessionStorage...</div>';
          sessionStorage.setItem("current_game", JSON.stringify(testGame));

          const storedData = sessionStorage.getItem("current_game");
          if (storedData) {
            const parsedGame = JSON.parse(storedData);
            resultsDiv.innerHTML +=
              '<div class="success">âœ… Game data stored and retrieved successfully</div>';
          } else {
            throw new Error("Failed to store game data");
          }

          // Step 5: Test URL construction
          const editorURL = `editor.html?game=${testGame.slug}`;
          resultsDiv.innerHTML += `<div class="step">ğŸ”— Step 5: Editor URL: ${editorURL}</div>`;

          // Step 6: Show what will be displayed in editor
          resultsDiv.innerHTML += `
                    <div class="step">ğŸ“‹ Step 6: Game Instructions Preview</div>
                    <div class="game-card">
                        <h3>ğŸ® ${testGame.title}</h3>
                        <div><strong>ğŸ¯ Objective:</strong> ${
                          testGame.description
                        }</div>
                        <div><strong>ğŸ“‹ Instructions:</strong> ${
                          testGame.instructions ||
                          "Complete the coding challenge!"
                        }</div>
                        <div><strong>âš¡ Difficulty:</strong> ${
                          testGame.difficulty
                        }</div>
                        <div><strong>â±ï¸ Time Limit:</strong> ${Math.floor(
                          testGame.time_limit / 60
                        )} minutes</div>
                        <div><strong>ğŸ¯ Max Score:</strong> ${
                          testGame.max_score
                        } points</div>
                        <div><strong>ğŸ† XP Reward:</strong> ${
                          testGame.xp_reward
                        } XP</div>
                        <div><strong>ğŸ“‚ Category:</strong> ${
                          testGame.category
                        }</div>
                        <div><strong>ğŸ·ï¸ Tags:</strong> ${testGame.tags.join(
                          ", "
                        )}</div>
                    </div>
                `;

          // Step 7: Test completion
          resultsDiv.innerHTML += `
                    <div class="success">âœ… Complete game flow test successful!</div>
                    <div class="step">ğŸš€ Ready to launch editor</div>
                    <button onclick="launchGameEditor('${testGame.slug}')">
                        ğŸ® Launch Game in Editor
                    </button>
                `;
        } catch (error) {
          resultsDiv.innerHTML += `<div class="error">âŒ Test failed: ${error.message}</div>`;
        }
      }

      function simulateGameLaunch() {
        const resultsDiv = document.getElementById("results");

        // Create a comprehensive test game
        const testGame = {
          id: "test-game-complete",
          slug: "complete-test-game",
          title: "Complete Test Game",
          description:
            "Build a responsive webpage with HTML, CSS, and JavaScript to demonstrate your web development skills.",
          instructions: `
                    <h4>ğŸ¯ Your Mission:</h4>
                    <p>Create a complete webpage that includes:</p>
                    <ul>
                        <li>ğŸ“„ <strong>HTML:</strong> Semantic structure with header, main content, and footer</li>
                        <li>ğŸ¨ <strong>CSS:</strong> Responsive styling with colors, fonts, and layout</li>
                        <li>âš¡ <strong>JavaScript:</strong> Interactive elements like buttons or animations</li>
                    </ul>
                    
                    <h4>ğŸ“‹ Requirements:</h4>
                    <ul>
                        <li>Use proper HTML5 semantic elements</li>
                        <li>Apply CSS for visual appeal and responsiveness</li>
                        <li>Add JavaScript for interactivity</li>
                        <li>Test your code before submitting</li>
                    </ul>
                    
                    <h4>ğŸ† Scoring:</h4>
                    <ul>
                        <li><strong>Code Quality (30 pts):</strong> Clean, well-structured code</li>
                        <li><strong>Functionality (40 pts):</strong> Working features and proper syntax</li>
                        <li><strong>Performance (30 pts):</strong> Efficient and complete implementation</li>
                    </ul>
                `,
          difficulty: "medium",
          time_limit: 1800, // 30 minutes
          max_score: 100,
          xp_reward: 75,
          category: "web-development",
          tags: ["html", "css", "javascript", "responsive", "interactive"],
          game_config: {
            starter_html:
              "<!DOCTYPE html>\n<html>\n<head>\n    <title>My Game Project</title>\n</head>\n<body>\n    <!-- Your HTML here -->\n</body>\n</html>",
            starter_css:
              "/* Your CSS styles here */\nbody {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n}",
            starter_js:
              "// Your JavaScript code here\nconsole.log('Game started!');",
          },
        };

        // Store the test game
        sessionStorage.setItem("current_game", JSON.stringify(testGame));

        resultsDiv.innerHTML = `
                <div class="success">âœ… Test game created and stored!</div>
                <div class="game-card">
                    <h3>ğŸ® ${testGame.title}</h3>
                    <p><strong>Instructions:</strong> ${
                      testGame.description
                    }</p>
                    <p><strong>Time Limit:</strong> ${Math.floor(
                      testGame.time_limit / 60
                    )} minutes</p>
                    <p><strong>Max Score:</strong> ${
                      testGame.max_score
                    } points</p>
                    <p><strong>XP Reward:</strong> ${testGame.xp_reward} XP</p>
                </div>
                <button onclick="launchGameEditor('${testGame.slug}')">
                    ğŸš€ Launch Complete Test Game
                </button>
            `;
      }

      function launchGameEditor(gameSlug) {
        // Launch the editor with the game
        window.location.href = `editor.html?game=${gameSlug}`;
      }

      // Auto-run test on page load
      window.addEventListener("load", () => {
        setTimeout(testCompleteFlow, 1000);
      });
    </script>
  </body>
</html>
