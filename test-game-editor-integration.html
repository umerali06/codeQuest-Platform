<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Game Editor Integration</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .test-section {
        background: #2a2a2a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid #444;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .info {
        color: #2196f3;
      }
      .warning {
        color: #ff9800;
      }
      pre {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .game-card {
        background: #333;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #555;
      }
      .game-title {
        color: #4caf50;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .game-slug {
        color: #888;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Test Game Editor Integration</h1>

    <div class="test-section">
      <h2>Step 1: Load Games from API</h2>
      <div id="gamesResults"></div>
      <button onclick="loadGames()">Load Games</button>
    </div>

    <div class="test-section">
      <h2>Step 2: Test Game Launch</h2>
      <div id="launchResults"></div>
      <div id="gamesList"></div>
    </div>

    <div class="test-section">
      <h2>Step 3: Test Editor Game Detection</h2>
      <div id="editorResults"></div>
      <button onclick="testEditorGameDetection()">Test Editor Detection</button>
    </div>

    <script>
      let availableGames = [];

      async function loadGames() {
        const resultsDiv = document.getElementById("gamesResults");
        const gamesListDiv = document.getElementById("gamesList");

        resultsDiv.innerHTML = '<div class="info">Loading games...</div>';

        try {
          const response = await fetch("/api/games");
          const responseText = await response.text();

          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            resultsDiv.innerHTML = `
                        <div class="error">‚ùå JSON Parse Error: ${
                          parseError.message
                        }</div>
                        <pre>Response: ${responseText.substring(0, 500)}</pre>
                    `;
            return;
          }

          if (data.success && data.data) {
            availableGames = data.data;
            resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Loaded ${data.data.length} games successfully!</div>
                    `;

            // Display games for testing
            const gamesHTML = data.data
              .map(
                (game) => `
                        <div class="game-card">
                            <div class="game-title">${game.icon} ${
                  game.title
                }</div>
                            <div class="game-slug">Slug: ${game.slug}</div>
                            <div>Difficulty: ${game.difficulty} | XP: ${
                  game.xp_reward
                }</div>
                            <div>Instructions: ${
                              game.instructions ? "Available" : "Missing"
                            }</div>
                            <button onclick="testGameLaunch('${game.slug}', '${
                  game.id
                }')">
                                Test Launch
                            </button>
                        </div>
                    `
              )
              .join("");

            gamesListDiv.innerHTML = gamesHTML;
          } else {
            resultsDiv.innerHTML = `
                        <div class="error">‚ùå API Error: ${
                          data.error || "Unknown error"
                        }</div>
                    `;
          }
        } catch (error) {
          resultsDiv.innerHTML = `
                    <div class="error">‚ùå Network Error: ${error.message}</div>
                `;
        }
      }

      function testGameLaunch(gameSlug, gameId) {
        const resultsDiv = document.getElementById("launchResults");

        // Find the game data
        const game = availableGames.find((g) => g.slug === gameSlug);
        if (!game) {
          resultsDiv.innerHTML = `<div class="error">‚ùå Game not found: ${gameSlug}</div>`;
          return;
        }

        // Simulate the game launch process
        resultsDiv.innerHTML = `
                <div class="info">üéÆ Testing game launch for: ${game.title}</div>
                <div class="info">üìù Storing game data in sessionStorage...</div>
            `;

        // Store game data like the real games.js does
        sessionStorage.setItem("current_game", JSON.stringify(game));

        // Test if data was stored correctly
        const storedGame = sessionStorage.getItem("current_game");
        if (storedGame) {
          const parsedGame = JSON.parse(storedGame);
          resultsDiv.innerHTML += `
                    <div class="success">‚úÖ Game data stored successfully</div>
                    <div class="info">üîó Would redirect to: editor.html?game=${gameSlug}</div>
                    <button onclick="simulateEditorLoad('${gameSlug}')">
                        Simulate Editor Load
                    </button>
                `;
        } else {
          resultsDiv.innerHTML += `
                    <div class="error">‚ùå Failed to store game data</div>
                `;
        }
      }

      function simulateEditorLoad(gameSlug) {
        const resultsDiv = document.getElementById("editorResults");

        resultsDiv.innerHTML = `
                <div class="info">üîÑ Simulating editor load with game: ${gameSlug}</div>
            `;

        // Simulate URL parameters
        const mockURLParams = new URLSearchParams(`game=${gameSlug}`);
        const gameSlugFromURL = mockURLParams.get("game");

        // Check sessionStorage
        const gameData = sessionStorage.getItem("current_game");

        if (gameSlugFromURL && gameData) {
          const game = JSON.parse(gameData);
          resultsDiv.innerHTML += `
                    <div class="success">‚úÖ Editor would detect game: ${
                      game.title
                    }</div>
                    <div class="info">üìã Instructions available: ${
                      game.instructions ? "Yes" : "No"
                    }</div>
                    <div class="info">‚è±Ô∏è Time limit: ${Math.floor(
                      game.time_limit / 60
                    )} minutes</div>
                    <div class="info">üéØ Max score: ${game.max_score}</div>
                    <div class="info">üèÜ XP reward: ${game.xp_reward}</div>
                    
                    <h4>Game Instructions:</h4>
                    <pre>${
                      game.instructions || "No instructions provided"
                    }</pre>
                    
                    <button onclick="openActualEditor('${gameSlug}')">
                        Open Actual Editor
                    </button>
                `;
        } else {
          resultsDiv.innerHTML += `
                    <div class="error">‚ùå Editor would not detect game properly</div>
                    <div class="error">Game slug from URL: ${
                      gameSlugFromURL || "Missing"
                    }</div>
                    <div class="error">Game data in storage: ${
                      gameData ? "Present" : "Missing"
                    }</div>
                `;
        }
      }

      function openActualEditor(gameSlug) {
        // Open the actual editor with the game parameter
        window.open(`editor.html?game=${gameSlug}`, "_blank");
      }

      function testEditorGameDetection() {
        const resultsDiv = document.getElementById("editorResults");

        resultsDiv.innerHTML = `
                <div class="info">üîç Testing editor game detection logic...</div>
            `;

        // Test URL parameter parsing
        const testURL = "editor.html?game=css-selector-master";
        const url = new URL(testURL, window.location.origin);
        const params = new URLSearchParams(url.search);
        const gameSlug = params.get("game");

        resultsDiv.innerHTML += `
                <div class="success">‚úÖ URL parsing works: ${gameSlug}</div>
            `;

        // Test sessionStorage
        const hasSessionData = sessionStorage.getItem("current_game") !== null;
        resultsDiv.innerHTML += `
                <div class="${hasSessionData ? "success" : "warning"}">
                    ${hasSessionData ? "‚úÖ" : "‚ö†Ô∏è"} SessionStorage: ${
          hasSessionData ? "Has game data" : "No game data"
        }
                </div>
            `;

        if (hasSessionData) {
          const gameData = JSON.parse(sessionStorage.getItem("current_game"));
          resultsDiv.innerHTML += `
                    <div class="info">üìä Current game in storage: ${gameData.title}</div>
                `;
        }
      }

      // Auto-load games on page load
      window.addEventListener("load", () => {
        setTimeout(loadGames, 1000);
      });
    </script>
  </body>
</html>
