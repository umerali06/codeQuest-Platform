<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Editor Issues</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .debug-section {
        background: #f5f5f5;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .error {
        background: #ffebee;
        border-left: 4px solid #f44336;
      }
      .success {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
      }
      .warning {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
      }
      .log {
        background: #000;
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>üîç Editor Issues Diagnostic</h1>

    <div class="debug-section">
      <h3>üöÄ Quick Tests</h3>
      <button onclick="testGameFlow()">Test Game Flow</button>
      <button onclick="testChallengeFlow()">Test Challenge Flow</button>
      <button onclick="testUIElements()">Test UI Elements</button>
      <button onclick="testAPIs()">Test APIs</button>
      <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
    </div>

    <div id="results" class="debug-section">
      <h3>üìä Results</h3>
      <div id="log" class="log"></div>
    </div>

    <!-- Hidden elements for testing -->
    <div style="display: none">
      <div id="challengeTitle">Test Title</div>
      <div id="challengeDifficulty">Easy</div>
      <div id="challengeXP">+50 XP</div>
      <div id="defaultDescription">Default description</div>
      <div id="gameInstructions">
        <div id="gameTitle">Game Title</div>
        <div id="gameDifficulty">Easy</div>
        <div id="gameDescription">Game description</div>
        <div id="objectivesList"></div>
        <div id="timeDisplay">00:00</div>
      </div>
      <div id="challengeInstructions">
        <div id="challengeTitlePanel">Challenge Title</div>
        <div id="challengeDifficultyPanel">Medium</div>
        <div id="challengeXPPanel">+50 XP</div>
        <div id="challengeDescriptionPanel">Challenge description</div>
        <div id="testStatements"></div>
      </div>
      <div id="gameResults"></div>
      <div id="challengeResults"></div>
      <div id="testResults"></div>
      <div id="html-monaco"></div>
      <div id="css-monaco"></div>
      <div id="js-monaco"></div>
      <button id="submitGameBtn">Submit Game</button>
      <button id="submitChallengeBtn">Submit Challenge</button>
      <button id="runTestsBtn">Run Tests</button>
    </div>

    <script src="public/editor.js"></script>
    <script>
      let editor;
      const log = document.getElementById("log");

      function logMessage(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          error: "#ff4444",
          success: "#44ff44",
          warning: "#ffaa44",
          info: "#44aaff",
        };
        log.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
        log.scrollTop = log.scrollHeight;
        console.log(message);
      }

      async function testGameFlow() {
        logMessage("üéÆ Testing Game Flow...", "info");

        try {
          // Test 1: Editor initialization
          if (!editor) {
            editor = new CodeEditor();
            logMessage("‚úÖ Editor initialized", "success");
          } else {
            logMessage("‚úÖ Editor already exists", "success");
          }

          // Test 2: Check game methods
          const gameMethods = [
            "checkForGame",
            "loadGameInstructions",
            "setupGameMode",
            "submitGame",
          ];
          gameMethods.forEach((method) => {
            if (typeof editor[method] === "function") {
              logMessage(`‚úÖ ${method} method exists`, "success");
            } else {
              logMessage(`‚ùå ${method} method missing`, "error");
            }
          });

          // Test 3: Simulate game loading
          const testGame = {
            id: "test-game",
            title: "Test Game",
            description: "This is a test game",
            difficulty: "easy",
            xp_reward: 50,
            objectives: ["Complete the task", "Submit your code"],
            starter_code: {
              html: "<div>Test HTML</div>",
              css: "div { color: red; }",
              js: 'console.log("test");',
            },
          };

          editor.currentGame = testGame;
          editor.loadGameInstructions(testGame);
          logMessage("‚úÖ Game instructions loaded", "success");

          // Test 4: Check if UI elements are populated
          const gameTitle = document.getElementById("gameTitle");
          if (gameTitle && gameTitle.textContent === testGame.title) {
            logMessage("‚úÖ Game title updated in UI", "success");
          } else {
            logMessage("‚ùå Game title not updated in UI", "error");
          }

          logMessage("üéâ Game flow test completed", "success");
        } catch (error) {
          logMessage(`‚ùå Game flow test failed: ${error.message}`, "error");
        }
      }

      async function testChallengeFlow() {
        logMessage("üéØ Testing Challenge Flow...", "info");

        try {
          // Test API call
          logMessage("Testing challenge API...", "info");
          const response = await fetch(
            "http://localhost:8000/api/challenges/contact-card"
          );

          if (!response.ok) {
            throw new Error(`API call failed: ${response.status}`);
          }

          const result = await response.json();
          logMessage("‚úÖ Challenge API working", "success");

          if (result.success && result.data) {
            logMessage(
              `‚úÖ Challenge data received: ${result.data.title}`,
              "success"
            );

            // Test challenge loading
            if (editor) {
              editor.currentChallenge = result.data;
              editor.displayChallenge(result.data);
              logMessage("‚úÖ Challenge displayed", "success");
            }
          } else {
            logMessage("‚ùå Invalid challenge data format", "error");
          }

          logMessage("üéâ Challenge flow test completed", "success");
        } catch (error) {
          logMessage(
            `‚ùå Challenge flow test failed: ${error.message}`,
            "error"
          );
        }
      }

      async function testUIElements() {
        logMessage("üé® Testing UI Elements...", "info");

        const requiredElements = [
          "challengeTitle",
          "challengeDifficulty",
          "challengeXP",
          "gameInstructions",
          "challengeInstructions",
          "submitGameBtn",
          "submitChallengeBtn",
          "runTestsBtn",
        ];

        let found = 0;
        requiredElements.forEach((elementId) => {
          const element = document.getElementById(elementId);
          if (element) {
            found++;
            logMessage(`‚úÖ Found: ${elementId}`, "success");
          } else {
            logMessage(`‚ùå Missing: ${elementId}`, "error");
          }
        });

        logMessage(
          `üìä UI Elements: ${found}/${requiredElements.length} found`,
          found === requiredElements.length ? "success" : "warning"
        );
      }

      async function testAPIs() {
        logMessage("üîå Testing APIs...", "info");

        try {
          // Test games API
          const gamesResponse = await fetch("http://localhost:8000/api/games");
          if (gamesResponse.ok) {
            const gamesData = await gamesResponse.json();
            logMessage(
              `‚úÖ Games API: ${gamesData.data?.length || 0} games found`,
              "success"
            );
          } else {
            logMessage(`‚ùå Games API failed: ${gamesResponse.status}`, "error");
          }

          // Test challenges API
          const challengesResponse = await fetch(
            "http://localhost:8000/api/challenges"
          );
          if (challengesResponse.ok) {
            const challengesData = await challengesResponse.json();
            logMessage(
              `‚úÖ Challenges API: ${
                challengesData.data?.length || 0
              } challenges found`,
              "success"
            );
          } else {
            logMessage(
              `‚ùå Challenges API failed: ${challengesResponse.status}`,
              "error"
            );
          }

          // Test specific game
          const gameResponse = await fetch(
            "http://localhost:8000/api/games?slug=html-speed-builder"
          );
          if (gameResponse.ok) {
            const gameData = await gameResponse.json();
            if (gameData.success && gameData.data.length > 0) {
              logMessage(
                `‚úÖ Specific game API working: ${gameData.data[0].title}`,
                "success"
              );
            }
          }

          // Test specific challenge
          const challengeResponse = await fetch(
            "http://localhost:8000/api/challenges/contact-card"
          );
          if (challengeResponse.ok) {
            const challengeData = await challengeResponse.json();
            if (challengeData.success && challengeData.data) {
              logMessage(
                `‚úÖ Specific challenge API working: ${challengeData.data.title}`,
                "success"
              );
            }
          }
        } catch (error) {
          logMessage(`‚ùå API test failed: ${error.message}`, "error");
        }
      }

      async function runFullDiagnostic() {
        logMessage("üîç Running Full Diagnostic...", "info");
        log.innerHTML = ""; // Clear previous logs

        await testAPIs();
        await testUIElements();
        await testGameFlow();
        await testChallengeFlow();

        logMessage("üéâ Full diagnostic completed!", "success");
      }

      // Test URL parameters
      function testURLParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const game = urlParams.get("game");
        const challenge = urlParams.get("challenge");

        if (game) {
          logMessage(`üéÆ Game parameter detected: ${game}`, "info");
        }
        if (challenge) {
          logMessage(`üéØ Challenge parameter detected: ${challenge}`, "info");
        }
        if (!game && !challenge) {
          logMessage("‚ÑπÔ∏è No URL parameters detected", "info");
        }
      }

      // Initialize
      window.addEventListener("load", () => {
        logMessage("üöÄ Diagnostic page loaded", "info");
        testURLParams();
      });
    </script>
  </body>
</html>
