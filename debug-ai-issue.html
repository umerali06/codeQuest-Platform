<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug AI Issue</title>
    <link rel="stylesheet" href="ai-assistant.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
      }
      button:hover {
        background-color: #0056b3;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        overflow-x: auto;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Debug AI Assistant Issues</h1>

      <div class="test-section info">
        <h2>üéØ Issues to Debug</h2>
        <ul>
          <li><strong>Send Button:</strong> Should show arrow (‚Üí) not "Sen"</li>
          <li>
            <strong>Input Visibility:</strong> Placeholder text should be
            clearly visible
          </li>
          <li>
            <strong>API Responses:</strong> Should get proper AI responses, not
            errors
          </li>
        </ul>
      </div>

      <div class="test-section">
        <h2>üß™ Debug Tests</h2>
        <button onclick="testSendButton()">Test Send Button</button>
        <button onclick="testInputVisibility()">Test Input Visibility</button>
        <button onclick="testAPIDirectly()">Test API Directly</button>
        <button onclick="testAIAssistant()">Test AI Assistant</button>
        <div id="testResults"></div>
      </div>

      <div class="test-section">
        <h2>üîß Manual Fixes</h2>
        <button onclick="clearCache()">Clear Browser Cache</button>
        <button onclick="reloadCSS()">Reload CSS</button>
        <button onclick="reinitializeAI()">Reinitialize AI</button>
      </div>
    </div>

    <!-- AI Assistant will be injected here -->
    <script src="ai-assistant.js"></script>

    <script>
      function testSendButton() {
        const resultDiv = document.getElementById("testResults");
        const sendBtn = document.getElementById("ai-send-btn");

        if (sendBtn) {
          const text = sendBtn.textContent || sendBtn.innerText;
          const styles = window.getComputedStyle(sendBtn);

          resultDiv.innerHTML = `<div class="result ${
            text === "‚Üí" ? "success" : "error"
          }">
                    <h3>${text === "‚Üí" ? "‚úÖ" : "‚ùå"} Send Button Test</h3>
                    <p><strong>Button Text:</strong> "${text}"</p>
                    <p><strong>Expected:</strong> "‚Üí"</p>
                    <p><strong>Width:</strong> ${styles.width}</p>
                    <p><strong>Height:</strong> ${styles.height}</p>
                    <p><strong>Font Size:</strong> ${styles.fontSize}</p>
                    ${
                      text !== "‚Üí"
                        ? "<p><strong>Issue:</strong> Button should show arrow symbol</p>"
                        : ""
                    }
                </div>`;
        } else {
          resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå Send Button Not Found</h3>
                    <p>The send button element is missing from the DOM.</p>
                </div>`;
        }
      }

      function testInputVisibility() {
        const resultDiv = document.getElementById("testResults");
        const input = document.getElementById("ai-input");

        if (input) {
          const styles = window.getComputedStyle(input);
          const placeholder = input.placeholder;

          resultDiv.innerHTML = `<div class="result success">
                    <h3>‚úÖ Input Field Test</h3>
                    <p><strong>Placeholder:</strong> "${placeholder}"</p>
                    <p><strong>Color:</strong> ${styles.color}</p>
                    <p><strong>Background:</strong> ${styles.background}</p>
                    <p><strong>Border:</strong> ${styles.border}</p>
                    <p><strong>Padding:</strong> ${styles.padding}</p>
                </div>`;
        } else {
          resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå Input Field Not Found</h3>
                    <p>The input field element is missing from the DOM.</p>
                </div>`;
        }
      }

      async function testAPIDirectly() {
        const resultDiv = document.getElementById("testResults");
        resultDiv.innerHTML =
          '<div class="result info"><h3>üîÑ Testing API Directly...</h3></div>';

        try {
          const testMessage = "How do I center a div with CSS?";
          console.log("Sending test message:", testMessage);

          const response = await fetch("/api/ai", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: testMessage,
            }),
          });

          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers);

          const responseText = await response.text();
          console.log("Raw response:", responseText);

          let data;
          try {
            data = JSON.parse(responseText);
          } catch (e) {
            throw new Error(`Invalid JSON: ${responseText}`);
          }

          if (data.success && data.response) {
            const isSpecificResponse =
              data.response.toLowerCase().includes("center") ||
              data.response.toLowerCase().includes("div") ||
              data.response.toLowerCase().includes("flexbox") ||
              data.response.toLowerCase().includes("margin");

            resultDiv.innerHTML = `<div class="result ${
              isSpecificResponse ? "success" : "error"
            }">
                        <h3>${
                          isSpecificResponse ? "‚úÖ" : "‚ö†Ô∏è"
                        } API Response Test</h3>
                        <p><strong>Status:</strong> ${response.status} OK</p>
                        <p><strong>Source:</strong> ${data.source}</p>
                        <p><strong>Response Type:</strong> ${
                          isSpecificResponse
                            ? "Specific Answer"
                            : "Generic Response"
                        }</p>
                        <p><strong>Response Length:</strong> ${
                          data.response.length
                        } characters</p>
                        <details>
                            <summary>View Full Response</summary>
                            <pre>${data.response}</pre>
                        </details>
                        ${
                          !isSpecificResponse
                            ? "<p><strong>Issue:</strong> API returning generic response instead of answering specific question</p>"
                            : ""
                        }
                    </div>`;
          } else {
            resultDiv.innerHTML = `<div class="result error">
                        <h3>‚ùå API Error</h3>
                        <p><strong>Error:</strong> ${
                          data.error || "Unknown error"
                        }</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
          }
        } catch (error) {
          console.error("API test failed:", error);
          resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå API Test Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                </div>`;
        }
      }

      async function testAIAssistant() {
        const resultDiv = document.getElementById("testResults");

        if (
          window.aiAssistant &&
          typeof window.aiAssistant.sendMessage === "function"
        ) {
          resultDiv.innerHTML =
            '<div class="result info"><h3>üîÑ Testing AI Assistant...</h3></div>';

          // Open the AI assistant
          if (typeof window.aiAssistant.toggleChat === "function") {
            window.aiAssistant.toggleChat();
          }

          // Wait a moment then send a test message
          setTimeout(async () => {
            try {
              await window.aiAssistant.sendMessage(
                "Test message: How do I use flexbox?"
              );

              resultDiv.innerHTML = `<div class="result success">
                            <h3>‚úÖ AI Assistant Test</h3>
                            <p>Test message sent successfully!</p>
                            <p>Check the AI chat window for the response.</p>
                            <p><strong>Note:</strong> If you see an error message in the chat, there's still an issue with the API integration.</p>
                        </div>`;
            } catch (error) {
              resultDiv.innerHTML = `<div class="result error">
                            <h3>‚ùå AI Assistant Error</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>`;
            }
          }, 1000);
        } else {
          resultDiv.innerHTML = `<div class="result error">
                    <h3>‚ùå AI Assistant Not Available</h3>
                    <p>The AI assistant is not properly initialized.</p>
                </div>`;
        }
      }

      function clearCache() {
        // Force reload without cache
        window.location.reload(true);
      }

      function reloadCSS() {
        // Reload CSS files
        const links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach((link) => {
          const href = link.href;
          link.href = href + "?v=" + Date.now();
        });

        const resultDiv = document.getElementById("testResults");
        resultDiv.innerHTML = `<div class="result success">
                <h3>‚úÖ CSS Reloaded</h3>
                <p>All CSS files have been reloaded with cache-busting.</p>
            </div>`;
      }

      function reinitializeAI() {
        // Remove existing AI assistant
        const existingWidget = document.getElementById("ai-assistant-widget");
        if (existingWidget) {
          existingWidget.remove();
        }

        // Clear the global variable
        window.aiAssistant = null;

        // Reinitialize
        setTimeout(() => {
          window.aiAssistant = new AIAssistant();

          const resultDiv = document.getElementById("testResults");
          resultDiv.innerHTML = `<div class="result success">
                    <h3>‚úÖ AI Assistant Reinitialized</h3>
                    <p>The AI assistant has been recreated.</p>
                    <p>Look for the AI button in the bottom-right corner.</p>
                </div>`;
        }, 500);
      }

      // Auto-run tests when page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          testSendButton();
        }, 1500);
      });
    </script>
  </body>
</html>
