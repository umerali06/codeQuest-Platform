<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Learning Paths Test - CodeQuest</title>
    <link rel="stylesheet" href="public/styles.css" />
    <link rel="stylesheet" href="public/learn-styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background: var(--darker);
        color: var(--light);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 2rem 0;
      }
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .test-title {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--light);
      }
      .api-status {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      .status-success {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
      }
      .status-error {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
      }
      .status-loading {
        background: rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
      }
      .test-buttons {
        text-align: center;
        margin-bottom: 2rem;
      }
      .test-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        margin: 0.5rem;
        transition: all 0.3s ease;
      }
      .test-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }
      .debug-info {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
        font-family: monospace;
        font-size: 0.9rem;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1 class="test-title">Dynamic Learning Paths Test</h1>

      <div id="apiStatus" class="api-status status-loading">
        <strong>API Status:</strong> Testing connection...
      </div>

      <div class="test-buttons">
        <button class="test-btn" onclick="testAPI()">
          Test API Connection
        </button>
        <button class="test-btn" onclick="loadPaths()">
          Load Learning Paths
        </button>
        <button class="test-btn" onclick="testEnrollment()">
          Test Enrollment
        </button>
        <button class="test-btn" onclick="clearDebug()">Clear Debug</button>
      </div>

      <div id="debugInfo" class="debug-info">
        Debug information will appear here...
      </div>

      <div id="pathsContainer">
        <!-- Learning paths will be loaded here -->
      </div>
    </div>

    <script>
      let debugLog = [];

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        debugLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        updateDebugDisplay();
      }

      function updateDebugDisplay() {
        const debugDiv = document.getElementById("debugInfo");
        debugDiv.innerHTML = debugLog.join("\n");
        debugDiv.scrollTop = debugDiv.scrollHeight;
      }

      function clearDebug() {
        debugLog = [];
        updateDebugDisplay();
      }

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("apiStatus");
        statusDiv.innerHTML = `<strong>API Status:</strong> ${message}`;
        statusDiv.className = `api-status status-${type}`;
      }

      async function testAPI() {
        log("Testing API connection...");
        updateStatus("Testing connection...", "loading");

        try {
          const response = await fetch("/api/health");
          const data = await response.json();

          if (response.ok) {
            log("API connection successful", "success");
            log(`API Response: ${JSON.stringify(data)}`);
            updateStatus("API Connected ✓", "success");
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          log(`API connection failed: ${error.message}`, "error");
          updateStatus("API Connection Failed ✗", "error");
        }
      }

      async function loadPaths() {
        log("Loading learning paths...");
        updateStatus("Loading paths...", "loading");

        try {
          const response = await fetch("/api/learning-paths");
          const data = await response.json();

          if (response.ok && data.success) {
            log(`Loaded ${data.paths.length} learning paths`, "success");

            data.paths.forEach((path) => {
              log(
                `Path: ${path.title} - ${path.total_modules} modules, ${path.estimated_hours}h, ${path.progress_percentage}% complete`
              );
            });

            renderPaths(data.paths);
            updateStatus(`Loaded ${data.paths.length} paths ✓`, "success");
          } else {
            throw new Error(data.error || "Failed to load paths");
          }
        } catch (error) {
          log(`Failed to load paths: ${error.message}`, "error");
          updateStatus("Failed to load paths ✗", "error");
        }
      }

      async function testEnrollment() {
        log("Testing enrollment...");

        try {
          // First get paths to find one to enroll in
          const pathsResponse = await fetch("/api/learning-paths");
          const pathsData = await pathsResponse.json();

          if (pathsData.success && pathsData.paths.length > 0) {
            const firstPath = pathsData.paths[0];
            log(`Attempting to enroll in: ${firstPath.title}`);

            const enrollResponse = await fetch("/api/learning-paths/enroll", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                path_id: firstPath.id,
              }),
            });

            const enrollData = await enrollResponse.json();

            if (enrollResponse.ok && enrollData.success) {
              log(`Enrollment successful: ${enrollData.message}`, "success");
            } else {
              log(`Enrollment failed: ${enrollData.error}`, "error");
            }
          } else {
            log("No paths available for enrollment test", "error");
          }
        } catch (error) {
          log(`Enrollment test failed: ${error.message}`, "error");
        }
      }

      function renderPaths(paths) {
        const container = document.getElementById("pathsContainer");

        if (paths.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: var(--text-muted);">No learning paths found</p>';
          return;
        }

        const pathsHTML = `
                <section class="learning-paths-section">
                    <div class="container">
                        <div class="section-header">
                            <h2>Dynamic Learning Paths</h2>
                            <p>All data loaded dynamically from database</p>
                        </div>
                        <div class="paths-container">
                            ${paths
                              .map((path) => renderPathCard(path))
                              .join("")}
                        </div>
                    </div>
                </section>
            `;

        container.innerHTML = pathsHTML;
      }

      function renderPathCard(path) {
        const progressPercentage = path.progress_percentage || 0;
        const status = path.status || "not_started";

        let buttonText = "Start Path";
        let buttonClass = "btn-secondary";

        if (status === "completed") {
          buttonText = "Review Path";
          buttonClass = "btn-success";
        } else if (status === "in_progress") {
          buttonText = "Continue Path";
          buttonClass = "btn-primary";
        }

        return `
                <div class="path-card ${path.slug}" data-path-id="${path.id}">
                    <div class="path-header">
                        <div class="path-icon">
                            <i class="${path.icon}"></i>
                        </div>
                        <h3>${path.title}</h3>
                    </div>
                    <p>${path.description}</p>
                    <div class="path-stats">
                        <span><i class="fas fa-clock"></i> ${
                          path.estimated_hours
                        } hours</span>
                        <span><i class="fas fa-graduation-cap"></i> ${
                          path.total_modules
                        } modules</span>
                    </div>
                    ${
                      progressPercentage > 0
                        ? `
                        <div class="path-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            <span>${progressPercentage}% complete</span>
                        </div>
                    `
                        : ""
                    }
                    <button class="btn ${buttonClass}" onclick="handlePathAction('${
          path.id
        }', '${status}', '${path.title}')">
                        ${buttonText}
                    </button>
                </div>
            `;
      }

      async function handlePathAction(pathId, status, title) {
        log(`Path action: ${status} for ${title}`);

        if (status === "not_started") {
          try {
            const response = await fetch("/api/learning-paths/enroll", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ path_id: pathId }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
              log(`Successfully enrolled in ${title}`, "success");
              // Reload paths to show updated progress
              await loadPaths();
            } else {
              log(`Enrollment failed: ${data.error}`, "error");
            }
          } catch (error) {
            log(`Enrollment error: ${error.message}`, "error");
          }
        } else {
          log(`Would navigate to ${title} (${status})`);
        }
      }

      // Auto-test on load
      document.addEventListener("DOMContentLoaded", async function () {
        log("Page loaded, starting tests...");
        await testAPI();
        await loadPaths();
      });
    </script>
  </body>
</html>
