<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Persistent Authentication Test - CodeQuest</title>
    <link rel="stylesheet" href="public/styles.css" />
    <link rel="stylesheet" href="public/learn-styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background: var(--darker);
        color: var(--light);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }

      .test-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .test-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        margin: 0.5rem;
        transition: all 0.3s ease;
      }

      .test-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .test-btn.secondary {
        background: var(--secondary);
      }

      .test-btn.danger {
        background: var(--danger);
      }

      .auth-status {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 2rem;
        margin: 2rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .status-indicator.online {
        background: #22c55e;
      }

      .status-indicator.offline {
        background: #ef4444;
      }

      .test-info {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 1rem;
        padding: 2rem;
        margin: 2rem 0;
      }

      .session-info {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
        font-family: monospace;
        font-size: 0.9rem;
      }

      .page-links {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin: 2rem 0;
      }

      .page-link {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .page-link:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1><i class="fas fa-shield-alt"></i> Persistent Authentication Test</h1>

      <div class="auth-status" id="authStatus">
        <h3>
          <span class="status-indicator offline" id="statusIndicator"></span
          >Authentication Status
        </h3>
        <div id="authDetails">
          <p>Checking authentication status...</p>
        </div>
      </div>

      <div class="test-info">
        <h3>Testing Persistent Authentication</h3>
        <p>This test verifies that user authentication persists across:</p>
        <ul>
          <li>✅ Page refreshes</li>
          <li>✅ Navigation between pages</li>
          <li>✅ Browser tab changes</li>
          <li>✅ Session storage</li>
          <li>✅ Cross-tab synchronization</li>
          <li>✅ Auto-logout on inactivity</li>
        </ul>
      </div>

      <div>
        <h3>Authentication Actions</h3>
        <button class="test-btn" onclick="showLogin()" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <button
          class="test-btn secondary"
          onclick="showSignup()"
          id="signupBtn"
        >
          <i class="fas fa-user-plus"></i> Sign Up
        </button>
        <button
          class="test-btn danger"
          onclick="logout()"
          id="logoutBtn"
          style="display: none"
        >
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        <button class="test-btn" onclick="refreshPage()">
          <i class="fas fa-sync"></i> Refresh Page
        </button>
        <button class="test-btn" onclick="validateSession()">
          <i class="fas fa-check-circle"></i> Validate Session
        </button>
      </div>

      <div class="page-links">
        <h3 style="width: 100%">Test Cross-Page Authentication</h3>
        <a href="learn.html" class="page-link">
          <i class="fas fa-graduation-cap"></i> Learn Page
        </a>
        <a href="index.html" class="page-link">
          <i class="fas fa-home"></i> Home Page
        </a>
        <a href="challenges.html" class="page-link">
          <i class="fas fa-trophy"></i> Challenges Page
        </a>
        <a href="dashboard.html" class="page-link">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
      </div>

      <div class="session-info" id="sessionInfo">
        <strong>Session Information:</strong><br />
        <span id="sessionDetails">No session data available</span>
      </div>

      <div class="test-info">
        <h3>Test Instructions:</h3>
        <ol>
          <li>Login or sign up using the buttons above</li>
          <li>Refresh this page - you should remain logged in</li>
          <li>Navigate to other pages - authentication should persist</li>
          <li>Open this page in a new tab - should show logged in state</li>
          <li>Logout from one tab - should logout from all tabs</li>
          <li>Wait for session expiry (24 hours) or test inactivity logout</li>
        </ol>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <button class="close" onclick="closeModal('loginModal')">
          &times;
        </button>
        <h2>Welcome Back!</h2>
        <p>Sign in to test persistent authentication</p>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="test@example.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="password123"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            Sign In
          </button>
        </form>
        <p class="modal-footer">
          Don't have an account?
          <a href="#" onclick="switchToSignup()">Sign up here</a>
        </p>
      </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
      <div class="modal-content">
        <button class="close" onclick="closeModal('signupModal')">
          &times;
        </button>
        <h2>Join CodeQuest!</h2>
        <p>Create an account to test persistent authentication</p>
        <form id="signupForm">
          <div class="form-group">
            <label for="signupName">Full Name</label>
            <input
              type="text"
              id="signupName"
              placeholder="Test User"
              required
            />
          </div>
          <div class="form-group">
            <label for="signupEmail">Email</label>
            <input
              type="email"
              id="signupEmail"
              placeholder="test@example.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="signupPassword">Password</label>
            <input
              type="password"
              id="signupPassword"
              placeholder="password123"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus"></i>
            Create Account
          </button>
        </form>
        <p class="modal-footer">
          Already have an account?
          <a href="#" onclick="switchToLogin()">Sign in here</a>
        </p>
      </div>
    </div>

    <script src="auth.js"></script>
    <script>
      function updateAuthStatus() {
        const statusIndicator = document.getElementById("statusIndicator");
        const authDetails = document.getElementById("authDetails");
        const sessionDetails = document.getElementById("sessionDetails");
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        if (window.AuthManager && window.AuthManager.isLoggedIn()) {
          const user = window.AuthManager.getCurrentUser();
          const progress = window.AuthManager.getProgress();

          statusIndicator.className = "status-indicator online";
          authDetails.innerHTML = `
                    <p><strong>Status:</strong> Logged In</p>
                    <p><strong>User:</strong> ${user.name || user.email}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>User ID:</strong> ${user.$id}</p>
                    <p><strong>Total XP:</strong> ${progress?.totalXP || 0}</p>
                    <p><strong>Level:</strong> ${progress?.level || 1} (${
            progress?.levelTitle || "Beginner"
          })</p>
                `;

          sessionDetails.innerHTML = `
                    User ID: ${user.$id}<br>
                    Session Expiry: ${user.sessionExpiry || "N/A"}<br>
                    Last Activity: ${user.lastActivity || "N/A"}<br>
                    Created: ${user.createdAt || "N/A"}
                `;

          loginBtn.style.display = "none";
          signupBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
        } else {
          statusIndicator.className = "status-indicator offline";
          authDetails.innerHTML = `
                    <p><strong>Status:</strong> Not Logged In</p>
                    <p>Please login to test persistent authentication.</p>
                `;

          sessionDetails.innerHTML = "No session data available";

          loginBtn.style.display = "inline-block";
          signupBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
        }
      }

      function refreshPage() {
        window.location.reload();
      }

      function validateSession() {
        if (window.AuthManager) {
          window.AuthManager.validateSession();
          setTimeout(updateAuthStatus, 500);
        }
      }

      function showLogin() {
        const modal = document.getElementById("loginModal");
        if (modal) {
          document.body.classList.add("modal-open");
          modal.classList.add("show");
          modal.style.display = "block";
        }
      }

      function showSignup() {
        const modal = document.getElementById("signupModal");
        if (modal) {
          document.body.classList.add("modal-open");
          modal.classList.add("show");
          modal.style.display = "block";
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add("hide");
          document.body.classList.remove("modal-open");
          setTimeout(() => {
            modal.style.display = "none";
            modal.classList.remove("show", "hide");
          }, 300);
        }
      }

      function switchToSignup() {
        closeModal("loginModal");
        setTimeout(() => showSignup(), 350);
      }

      function switchToLogin() {
        closeModal("signupModal");
        setTimeout(() => showLogin(), 350);
      }

      function logout() {
        if (window.AuthManager) {
          window.AuthManager.logout();
        }
      }

      // Setup auth state listener
      document.addEventListener("DOMContentLoaded", function () {
        // Initial status update
        setTimeout(updateAuthStatus, 500);

        // Listen for auth state changes
        if (window.AuthManager) {
          window.AuthManager.onAuthStateChange(function (user) {
            console.log(
              "Auth state changed:",
              user ? "Logged in" : "Logged out"
            );
            updateAuthStatus();
          });
        }

        // Update status every 5 seconds
        setInterval(updateAuthStatus, 5000);

        // Setup form handlers
        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
          loginForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            try {
              await window.AuthManager.login(email, password);
              closeModal("loginModal");
              alert("Login successful!");
            } catch (error) {
              alert("Login failed: " + error.message);
            }
          });
        }

        const signupForm = document.getElementById("signupForm");
        if (signupForm) {
          signupForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const name = document.getElementById("signupName").value;
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;

            try {
              await window.AuthManager.register(name, email, password);
              closeModal("signupModal");
              alert("Account created successfully!");
            } catch (error) {
              alert("Signup failed: " + error.message);
            }
          });
        }
      });

      // Close modal when clicking outside
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          const modalId = e.target.id;
          closeModal(modalId);
        }
      });

      // Close modal with Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const openModals = document.querySelectorAll(".modal.show");
          openModals.forEach((modal) => closeModal(modal.id));
        }
      });
    </script>
  </body>
</html>
