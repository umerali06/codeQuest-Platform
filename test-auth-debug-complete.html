<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Auth Debug</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #0f172a;
        color: #f8fafc;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: rgba(15, 23, 42, 0.8);
        padding: 30px;
        border-radius: 15px;
        border: 1px solid rgba(99, 102, 241, 0.2);
      }
      .status {
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        margin: 10px 0;
      }
      .status.success {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      .status.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }
      .status.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .status.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }
      .test-button {
        background: #6366f1;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      .test-button:hover {
        background: #5855f7;
        transform: translateY(-1px);
      }
      .test-button.success {
        background: #10b981;
      }
      .test-button.success:hover {
        background: #059669;
      }
      .test-button.warning {
        background: #f59e0b;
      }
      .test-button.warning:hover {
        background: #d97706;
      }
      .code-block {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
      }
      .section {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Complete Authentication Debug</h1>
      <p>Comprehensive debugging for the games authentication system.</p>

      <div class="section">
        <h3>üéØ Debug Steps:</h3>
        <ol>
          <li>Check local storage for auth tokens</li>
          <li>Test /api/user endpoint response</li>
          <li>Simulate authentication flow</li>
          <li>Test playGame functionality</li>
          <li>Verify games page integration</li>
        </ol>
      </div>

      <div>
        <button class="test-button" onclick="step1_checkStorage()">
          1Ô∏è‚É£ Check Storage
        </button>
        <button class="test-button" onclick="step2_testUserAPI()">
          2Ô∏è‚É£ Test User API
        </button>
        <button class="test-button" onclick="step3_simulateAuth()">
          3Ô∏è‚É£ Simulate Auth
        </button>
        <button class="test-button" onclick="step4_testPlayGame()">
          4Ô∏è‚É£ Test Play Game
        </button>
        <button class="test-button success" onclick="step5_openGames()">
          5Ô∏è‚É£ Open Games Page
        </button>
        <button class="test-button warning" onclick="clearAll()">
          üóëÔ∏è Clear All
        </button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      function log(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        results.appendChild(div);
      }

      function showCode(data, title = "Data") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.innerHTML = `<strong>${title}:</strong>`;
        results.appendChild(div);

        const codeDiv = document.createElement("div");
        codeDiv.className = "code-block";
        codeDiv.textContent =
          typeof data === "string" ? data : JSON.stringify(data, null, 2);
        results.appendChild(codeDiv);
      }

      function step1_checkStorage() {
        log("1Ô∏è‚É£ Checking local storage...", "info");

        const authToken = localStorage.getItem("auth_token");
        const sessionToken = sessionStorage.getItem("auth_token");

        if (authToken) {
          log(
            `‚úÖ localStorage auth_token found: ${authToken.length} chars`,
            "success"
          );
          showCode(authToken, "localStorage auth_token");
        } else {
          log("‚ùå No auth_token in localStorage", "error");
        }

        if (sessionToken) {
          log(
            `‚úÖ sessionStorage auth_token found: ${sessionToken.length} chars`,
            "success"
          );
          showCode(sessionToken, "sessionStorage auth_token");
        } else {
          log("‚ùå No auth_token in sessionStorage", "error");
        }

        // Check all keys
        const allLocalKeys = Object.keys(localStorage);
        const allSessionKeys = Object.keys(sessionStorage);

        log(
          `üìã localStorage keys (${allLocalKeys.length}): ${
            allLocalKeys.join(", ") || "none"
          }`,
          "info"
        );
        log(
          `üìã sessionStorage keys (${allSessionKeys.length}): ${
            allSessionKeys.join(", ") || "none"
          }`,
          "info"
        );
      }

      async function step2_testUserAPI() {
        log("2Ô∏è‚É£ Testing /api/user endpoint...", "info");

        const token =
          localStorage.getItem("auth_token") ||
          sessionStorage.getItem("auth_token");

        if (!token) {
          log("‚ùå No token available for testing", "error");
          return;
        }

        try {
          log(
            `üì° Making request with token: ${token.substring(0, 15)}...`,
            "info"
          );

          const response = await fetch("/api/user", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          log(
            `üìä Response status: ${response.status} ${response.statusText}`,
            response.ok ? "success" : "error"
          );
          log(
            `üìã Content-Type: ${response.headers.get("content-type")}`,
            "info"
          );

          const responseText = await response.text();
          log(`üìÑ Response length: ${responseText.length} characters`, "info");

          // Check for PHP errors
          if (responseText.includes("<b>Fatal error</b>")) {
            log("‚ùå PHP Fatal Error detected!", "error");
            showCode(responseText.substring(0, 500), "PHP Error");
            return;
          }

          if (responseText.includes("Cannot redeclare")) {
            log("‚ùå Function redeclaration error!", "error");
            showCode(responseText.substring(0, 500), "PHP Error");
            return;
          }

          // Try to parse JSON
          try {
            const result = JSON.parse(responseText);
            log("‚úÖ JSON parsing successful", "success");
            showCode(result, "API Response");

            // Analyze response format
            if (result.success && result.user) {
              log(
                "‚úÖ Response format: { success: true, user: {...} }",
                "success"
              );
            } else if (result.id || result.username || result.email) {
              log("‚úÖ Response format: direct user object", "success");
            } else if (result.error) {
              log(`‚ùå API returned error: ${result.error}`, "error");
            } else {
              log("‚ö†Ô∏è Unexpected response format", "warning");
            }
          } catch (jsonError) {
            log(`‚ùå JSON parse error: ${jsonError.message}`, "error");
            showCode(responseText.substring(0, 500), "Raw Response");
          }
        } catch (error) {
          log(`‚ùå Request failed: ${error.message}`, "error");
        }
      }

      function step3_simulateAuth() {
        log("3Ô∏è‚É£ Simulating authentication...", "info");

        // Create a test token (you might need to use a real one from your system)
        const testToken = prompt(
          "Enter a valid auth token (or leave empty for fake token):"
        );
        const tokenToUse = testToken || `test_token_${Date.now()}`;

        localStorage.setItem("auth_token", tokenToUse);

        log(`‚úÖ Set auth token: ${tokenToUse.substring(0, 20)}...`, "success");
        log("üîÑ Now test the User API to see if it works", "info");
      }

      function step4_testPlayGame() {
        log("4Ô∏è‚É£ Testing playGame functionality...", "info");

        // Simulate the games page authentication check
        const token =
          localStorage.getItem("auth_token") ||
          sessionStorage.getItem("auth_token");

        if (!token) {
          log("‚ùå No token - playGame should show login required", "warning");
          showTestToast("Please log in to play games", "warning");
          return;
        }

        log("‚úÖ Token found - simulating authenticated playGame", "success");

        // Simulate a user object
        const mockUser = {
          id: "123",
          username: "TestUser",
          email: "test@example.com",
        };

        log(
          `üéÆ Simulating playGame with user: ${mockUser.username}`,
          "success"
        );
        showTestToast(`Game launching for ${mockUser.username}...`, "success");
      }

      function step5_openGames() {
        log("5Ô∏è‚É£ Opening games page for live testing...", "info");
        window.open("public/games.html", "_blank");
      }

      function clearAll() {
        localStorage.removeItem("auth_token");
        sessionStorage.removeItem("auth_token");
        document.getElementById("results").innerHTML = "";
        log("üóëÔ∏è Cleared all data and results", "info");
      }

      // Toast function for testing
      function showTestToast(message, type = "info") {
        const existingToasts = document.querySelectorAll(".toast-notification");
        existingToasts.forEach((toast) => toast.remove());

        const toast = document.createElement("div");
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
              <div class="toast-content">
                <div class="toast-icon">
                  ${
                    type === "success"
                      ? "‚úÖ"
                      : type === "warning"
                      ? "‚ö†Ô∏è"
                      : type === "error"
                      ? "‚ùå"
                      : "‚ÑπÔ∏è"
                  }
                </div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
              </div>
            `;

        // Add styles if needed
        if (!document.getElementById("toast-styles")) {
          const styles = document.createElement("style");
          styles.id = "toast-styles";
          styles.textContent = `
                    .toast-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        background: rgba(15, 23, 42, 0.95);
                        border-radius: 12px;
                        border: 1px solid rgba(99, 102, 241, 0.3);
                        backdrop-filter: blur(10px);
                        animation: slideInRight 0.3s ease-out;
                        box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
                    }
                    .toast-content {
                        display: flex;
                        align-items: center;
                        padding: 16px;
                        gap: 12px;
                    }
                    .toast-icon {
                        font-size: 1.2em;
                        flex-shrink: 0;
                    }
                    .toast-message {
                        flex: 1;
                        color: #f8fafc;
                        font-weight: 500;
                    }
                    .toast-close {
                        background: none;
                        border: none;
                        color: #94a3b8;
                        font-size: 1.2em;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }
                    .toast-close:hover {
                        background: rgba(255, 255, 255, 0.1);
                        color: #f8fafc;
                    }
                    .toast-success {
                        border-color: rgba(16, 185, 129, 0.5);
                        background: rgba(16, 185, 129, 0.1);
                    }
                    .toast-warning {
                        border-color: rgba(245, 158, 11, 0.5);
                        background: rgba(245, 158, 11, 0.1);
                    }
                    .toast-error {
                        border-color: rgba(239, 68, 68, 0.5);
                        background: rgba(239, 68, 68, 0.1);
                    }
                    .toast-info {
                        border-color: rgba(59, 130, 246, 0.5);
                        background: rgba(59, 130, 246, 0.1);
                    }
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
          document.head.appendChild(styles);
        }

        document.body.appendChild(toast);

        setTimeout(() => {
          if (toast.parentElement) {
            toast.style.animation = "slideInRight 0.3s ease-out reverse";
            setTimeout(() => toast.remove(), 300);
          }
        }, 4000);
      }

      // Auto-run on load
      document.addEventListener("DOMContentLoaded", () => {
        log("üîß Complete auth debug tool loaded", "info");
        log("üëÜ Click the numbered buttons to run each debug step", "info");
      });
    </script>
  </body>
</html>
